events {
    worker_connections 1024;
}

http {
    upstream gateway_servers {
        server gateway-service:9700;
        # 如果有多个实例可以这样配置：
        # server gateway-service:9700 weight=3;
        # server gateway-service2:9700 weight=2;
    }

    upstream auth_servers {
        server auth-service:8184;
    }

    upstream user_servers {
        server user-service:8555;
    }

    upstream ai_servers {
        server ai-service:7009;
    }

    upstream order_servers {
        server order-service:8086;
    }

#     upstream pay_servers {
#         server pay-service:8087;
#     }

    upstream message_servers {
        server message-service:8085;
    }

    upstream email_servers {
        server email-service:8083;
    }

    upstream promotion_servers {
        server promotion-service:7010;
    }

    upstream task_servers {
        server task-service:8090;
    }

    upstream websocket_servers {
        server websocket-service:6111;
    }

    upstream xxl_job_admin_servers {
        server xxl-job-admin:9001;
    }

    upstream sentinel_servers {
        server sentinel-dashboard-service:8099;
    }

    # 主网关路由配置
    server {
        listen 80;
        server_name localhost;

        # 健康检查端点
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # API 网关路由
        location /api/ {
            proxy_pass http://gateway_servers/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 超时配置
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # 直接服务路由（如果需要绕过网关）
        location /auth/ {
            proxy_pass http://auth_servers/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /user/ {
            proxy_pass http://user_servers/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /ai/ {
            proxy_pass http://ai_servers/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebSocket 支持
        location /open-platform/websocket/ {
            proxy_pass http://gateway_servers/open-platform/websocket;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # 关键配置：防止超时断开
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_connect_timeout 30s;

            # 保持连接活跃
            proxy_set_header Connection "";
            proxy_buffering off;
        }

        # xxl-job管理界面路由
        location /xxl-job-admin/ {
            proxy_pass http://xxl_job_admin_servers/xxl-job-admin/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /sentinel/ {
            proxy_pass http://sentinel_servers/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}